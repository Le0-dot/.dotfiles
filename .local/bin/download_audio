#!/bin/bash

audio_format="m4a"

# Check wether arguments are enough for work
if [ $# -ge 1 ]
then
    # Define configuration variables
    next_pattern=false
    pattern=""
    rename=true
    for arg in ${@:1}
    do
	if [ "$next_pattern" = true ]
	then
	    pattern="$arg"
	    next_pattern=false
	    continue
	fi
	case "$arg" in
	    "--pattern")
		next_pattern=true
		;;
	    "--no-rename")
		rename=false
		;;
	esac
    done
    mkdir tmp
    cd tmp
    # Download audio files from youtube via youtube-dl
    youtube-dl -o '%(title)s.%(ext)s' --match-title "$pattern" -x --audio-format $audio_format --audio-quality 128K "$1"
    # Rename all dowloaded files that only track names were left if needed
    if [ "$rename" = true ]
    then
	for f in *.$audio_format
	do
	   mv "$f" "$(echo $f | sed 's/ ([A-Z ]\{14\})//g; s/^[0-9a-zA-Z ]*//g; s/^[ -]*//g')"
	done
    fi
    mv * ../
    cd ..
    rmdir ./tmp
# Show error if arguments are not enough
else
    echo "Error: bash: download_audio: Expected at least 1 argument given 0"
fi
